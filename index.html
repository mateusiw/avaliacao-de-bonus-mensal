<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Relat√≥rio de B√¥nus Mensal</title>
    
    <!-- Configura√ß√µes PWA Embutidas -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"B√¥nus Mensal","short_name":"B√¥nus","start_url":".","display":"standalone","background_color":"#f8fafc","theme_color":"#2563eb","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3135/3135715.png","sizes":"512x512","type":"image/png"}]}'>
    
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- CSS Cr√≠tico -->
    <style>
        body { font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        @media print {
            @page { margin: 1cm; size: landscape; }
            .no-print { display: none !important; }
        }
        
        .hidden-force { display: none !important; }
        
        /* Scrollbar personalizada sutil */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Anima√ß√µes simples para feedback visual */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN - Idealmente seria compilado, mas mantido para single-file) -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-slate-800 min-h-screen font-sans">

    <!-- TELA DE LOGIN (SECTION) -->
    <section id="login-screen" class="fixed inset-0 z-50 bg-gray-50 flex items-center justify-center p-4" aria-label="Tela de Login">
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-8 w-full max-w-md animate-fade-in">
            <header class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                    <i data-lucide="lock" class="w-8 h-8 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">Acesso Restrito</h1>
                <p class="text-slate-500 text-sm mt-2">Sistema de Gest√£o de B√¥nus</p>
            </header>
            
            <form onsubmit="handleLogin(event)" class="space-y-5">
                <div>
                    <label for="loginUser" class="block text-xs font-semibold text-slate-600 uppercase tracking-wide mb-1.5">Usu√°rio</label>
                    <input type="text" id="loginUser" autocomplete="username" class="w-full p-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="Digite seu usu√°rio" required>
                </div>
                
                <div>
                    <label for="loginPass" class="block text-xs font-semibold text-slate-600 uppercase tracking-wide mb-1.5">Senha</label>
                    <!-- Readicionado o atributo 'required' pois agora todos t√™m senha -->
                    <input type="password" id="loginPass" autocomplete="current-password" class="w-full p-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>

                <div id="loginError" class="hidden p-3 bg-red-50 text-red-600 text-sm rounded-xl text-center font-medium border border-red-100" role="alert">
                    Usu√°rio ou senha incorretos.
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-md hover:shadow-lg active:scale-[0.98]">
                    Entrar no Sistema
                </button>
            </form>
        </div>
    </section>

    <!-- CONTE√öDO PRINCIPAL DO APP -->
    <div id="app-content" class="hidden flex flex-col min-h-screen">
        
        <!-- Navbar Superior (HEADER) -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-20 shadow-sm no-print">
            <div class="max-w-7xl mx-auto px-4 md:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg text-white">
                        <i data-lucide="calculator" class="w-5 h-5"></i>
                    </div>
                    <h1 class="text-lg font-bold text-slate-900 hidden sm:block">Gest√£o de B√¥nus</h1>
                </div>

                <nav class="flex items-center gap-4">
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-gray-50 rounded-full border border-gray-200">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                        <span class="text-xs font-semibold text-slate-600" id="userRoleDisplay"></span>
                    </div>
                    <button onclick="handleLogout()" class="text-slate-400 hover:text-red-600 transition-colors" title="Sair" aria-label="Sair do sistema">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </nav>
            </div>
        </header>

        <main class="flex-1 max-w-7xl w-full mx-auto p-4 md:p-8 space-y-8">
            
            <!-- Barra de Controles (SECTION) -->
            <section class="flex flex-col xl:flex-row gap-4 items-start xl:items-center justify-between no-print" data-html2canvas-ignore="true" aria-label="Barra de Ferramentas">
                
                <!-- T√≠tulo Din√¢mico -->
                <header>
                    <h2 class="text-2xl font-bold text-slate-800" id="headerTitle">Relat√≥rio Geral</h2>
                    <p class="text-slate-500 text-sm mt-1">Gerencie a produ√ß√£o e o desempenho da equipe.</p>
                </header>

                <!-- Bot√µes de A√ß√£o -->
                <div class="flex flex-wrap gap-2 w-full xl:w-auto items-center">
                    
                    <!-- Seletor de M√™s -->
                    <div class="relative group bg-white border border-gray-200 rounded-lg shadow-sm flex items-center h-10">
                        <div class="pl-3 text-slate-400">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                        </div>
                        <input type="month" id="referenceMonth" onchange="updateConfig('referenceMonth', this.value); updateTitle();" class="bg-transparent border-none text-slate-700 text-sm font-medium py-1.5 pl-2 pr-3 focus:ring-0 outline-none cursor-pointer h-full" aria-label="Seletor de M√™s de Refer√™ncia">
                    </div>
                    
                    <!-- FILTRO POR NOME (NA TABELA) - Classe admin-only adicionada -->
                    <div class="relative group bg-white border border-gray-200 rounded-lg shadow-sm flex items-center h-10 admin-only">
                        <div class="pl-3 text-slate-400">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </div>
                        <select id="filterEmployee" onchange="renderAll()" class="bg-transparent border-none text-slate-700 text-sm font-medium py-1.5 pl-2 pr-8 focus:ring-0 cursor-pointer outline-none w-40 h-full" aria-label="Filtrar por Funcion√°rio">
                            <option value="">Todos</option>
                            <!-- JS popula -->
                        </select>
                    </div>

                    <div class="h-8 w-px bg-gray-300 mx-1 hidden sm:block"></div>

                    <!-- Bot√µes Admin -->
                    <div class="admin-only flex gap-2">
                        <button onclick="toggleSettings()" class="p-2 h-10 w-10 flex items-center justify-center bg-white border border-gray-200 text-slate-600 rounded-lg hover:bg-gray-50 hover:text-blue-600 transition-all shadow-sm" title="Configurar Regra" aria-label="Configurar Porcentagem do Ponto">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                        </button>
                        <button onclick="viewTeamDatabase()" class="relative p-2 h-10 w-10 flex items-center justify-center bg-white border border-gray-200 text-slate-600 rounded-lg hover:bg-gray-50 hover:text-blue-600 transition-all shadow-sm group" title="Equipe" aria-label="Ver Equipe">
                            <i data-lucide="users-2" class="w-5 h-5"></i>
                            <span id="teamCountBadge" class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-blue-600 text-[10px] font-bold text-white border-2 border-white">0</span>
                        </button>
                        <button onclick="resetData()" class="p-2 h-10 w-10 flex items-center justify-center bg-white border border-gray-200 text-slate-400 rounded-lg hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-all shadow-sm" title="Limpar Tudo" aria-label="Limpar Dados">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="h-8 w-px bg-gray-300 mx-1 hidden sm:block admin-only"></div>

                    <!-- Import/Export -->
                    <div class="admin-only flex gap-2">
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                        <button onclick="document.getElementById('csvFileInput').click()" class="flex items-center gap-2 px-3 h-10 bg-white border border-gray-200 text-slate-700 rounded-lg text-sm font-medium hover:bg-gray-50 hover:text-blue-600 transition-all shadow-sm">
                            <i data-lucide="upload" class="w-4 h-4"></i> <span class="hidden lg:inline">Importar</span>
                        </button>
                        <button onclick="exportToCSV()" class="flex items-center gap-2 px-3 h-10 bg-white border border-gray-200 text-slate-700 rounded-lg text-sm font-medium hover:bg-gray-50 hover:text-green-600 transition-all shadow-sm">
                            <i data-lucide="download" class="w-4 h-4"></i> <span class="hidden lg:inline">Exportar</span>
                        </button>
                    </div>

                    <!-- Fichas & Opera√ß√£o -->
                    <div class="flex gap-2">
                        <!-- Admin Only para os bot√µes pequenos (J√° que o L√≠der tem os grandes) -->
                        <div class="admin-only flex bg-white border border-gray-200 rounded-lg shadow-sm p-0.5 h-10 items-center">
                            <button onclick="downloadManualSheets()" class="px-3 py-1.5 h-full flex items-center text-slate-600 hover:text-blue-600 hover:bg-blue-50 rounded-md text-sm font-medium transition-all" title="Imprimir Manual">
                                <i data-lucide="printer" class="w-4 h-4"></i>
                            </button>
                            <div class="w-px h-6 bg-gray-200 mx-1"></div>
                            <button onclick="openDigitalSheet()" class="px-3 py-1.5 h-full flex items-center text-slate-600 hover:text-blue-600 hover:bg-blue-50 rounded-md text-sm font-medium transition-all" title="Preencher Digital">
                                <i data-lucide="monitor-check" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        <!-- BOT√ÉO RENOMEADO: Imprimir -->
                        <button onclick="printSimpleTable()" class="admin-only flex items-center gap-2 px-4 h-10 bg-white border border-gray-200 text-slate-700 hover:text-blue-600 hover:bg-gray-50 rounded-lg text-sm font-bold shadow-sm transition-all">
                            <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
                        </button>
                    </div>
                </div>
            </section>

            <!-- Painel de Configura√ß√£o (SECTION/TOGGLE) -->
            <section id="settingsPanel" class="hidden no-print" data-html2canvas-ignore="true" aria-label="Configura√ß√µes">
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl shadow-inner flex items-center gap-4 animate-in slide-in-from-top-2">
                    <div class="p-2 bg-white rounded-lg text-blue-600 shadow-sm">
                        <i data-lucide="percent" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <label for="pointValue" class="block text-xs font-bold text-blue-800 uppercase tracking-wide mb-1">
                            Fator de Convers√£o (%)
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="pointValue" step="0.1" oninput="updateConfig('pointValue', this.value); renderAll();" class="w-24 p-1 rounded border border-blue-200 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-blue-600 font-bold">%</span>
                        </div>
                        <p class="text-[10px] text-blue-400 mt-1">Padr√£o 0.1 para que 70 pts = 7%.</p>
                    </div>
                </div>
            </section>

            <!-- Cards de Resumo (SECTION) -->
            <section class="admin-only grid grid-cols-1 md:grid-cols-2 gap-6" aria-label="Estat√≠sticas">
                <!-- Card B√¥nus -->
                <article class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex items-center justify-between group hover:border-emerald-200 transition-colors">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total em B√¥nus</p>
                        <!-- HTML5 OUTPUT -->
                        <output class="block text-3xl font-extrabold text-slate-800 tracking-tight" id="totalBonusDisplay">R$ 0,00</output>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="banknote" class="w-6 h-6"></i>
                    </div>
                </article>

                <!-- Card Funcion√°rios -->
                <article class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex items-center justify-between group hover:border-blue-200 transition-colors">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Equipe Avaliada</p>
                        <!-- HTML5 OUTPUT -->
                        <output class="block text-3xl font-extrabold text-slate-800 tracking-tight" id="totalEmployeesDisplay">0</output>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                </article>
            </section>

            <!-- Conte√∫do Principal -->
            
            <!-- Dashboard Lider (SECTION) -->
            <section id="leader-dashboard" class="hidden mt-10 animate-fade-in" aria-label="Painel do L√≠der">
                 <div class="text-center mb-12">
                    <h2 class="text-2xl font-bold text-slate-800">Painel do Avaliador</h2>
                    <p class="text-slate-500 mt-2">Escolha o m√©todo de avalia√ß√£o da equipe.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                    <button onclick="downloadManualSheets()" class="flex flex-col items-center justify-center p-10 bg-white border border-gray-200 rounded-2xl hover:border-blue-500 hover:shadow-xl hover:-translate-y-1 transition-all group h-48">
                        <i data-lucide="printer" class="w-10 h-10 text-slate-400 group-hover:text-blue-600 mb-4 transition-colors"></i>
                        <h3 class="text-lg font-bold text-slate-800">Imprimir Fichas</h3>
                        <p class="text-slate-500 text-center text-sm">Para preenchimento manual</p>
                    </button>
                    <button onclick="openDigitalSheet()" class="flex flex-col items-center justify-center p-10 bg-white border border-gray-200 rounded-2xl hover:border-emerald-500 hover:shadow-xl hover:-translate-y-1 transition-all group h-48">
                        <i data-lucide="laptop" class="w-10 h-10 text-slate-400 group-hover:text-emerald-600 mb-4 transition-colors"></i>
                        <h3 class="text-lg font-bold text-slate-800">Avalia√ß√£o Digital</h3>
                        <p class="text-slate-500 text-center text-sm">Preencher no sistema</p>
                    </button>
                </div>
            </section>

            <!-- Dashboard Admin (Tabela e Form) -->
            <div id="admin-dashboard-content" class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                
                <!-- Tabela Principal (SECTION) -->
                <section class="xl:col-span-2 flex flex-col gap-4" aria-label="Tabela de Dados">
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden flex-1">
                        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">Detalhamento da Folha</h3>
                            <span class="text-xs font-medium text-slate-400 bg-white px-2 py-1 rounded border border-gray-200">M√™s Atual</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-white text-slate-500 border-b border-gray-100 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="p-4 font-semibold text-slate-700">Nome</th>
                                        <th class="p-4 font-medium text-center text-xs uppercase tracking-wider">Caixas</th>
                                        <th class="p-4 font-medium text-center text-xs uppercase tracking-wider bg-blue-50/50">Prod.</th>
                                        <!-- Crit√©rios compactos -->
                                        <th class="p-2 text-center text-[10px] uppercase text-slate-400">Assid</th>
                                        <th class="p-2 text-center text-[10px] uppercase text-slate-400">Org</th>
                                        <th class="p-2 text-center text-[10px] uppercase text-slate-400">Part</th>
                                        <th class="p-2 text-center text-[10px] uppercase text-slate-400">Agil</th>
                                        <th class="p-2 text-center text-[10px] uppercase text-slate-400">Pont</th>
                                        
                                        <th class="p-4 font-medium text-center text-xs uppercase tracking-wider bg-emerald-50/50">Pts Totais</th>
                                        <th class="p-4 font-bold text-right text-emerald-600">B√¥nus</th>
                                        <th class="p-4 font-bold text-right text-slate-800">Total</th>
                                        <th class="p-4 w-16 no-print"></th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTableBody" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Legenda -->
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-xs text-slate-500 flex flex-col md:flex-row gap-8 justify-between">
                         <div>
                            <strong class="block mb-1 text-slate-700 uppercase tracking-wide text-[10px]">Tabela de Produ√ß√£o</strong>
                            <ul class="space-y-0.5 list-disc list-inside marker:text-blue-300">
                                <li>200 a 400 cx: 20 pts</li>
                                <li>401 a 600 cx: 30 pts</li>
                                <li>601 a 800 cx: 50 pts</li>
                                <li>801 a 1500 cx: 60 pts</li>
                            </ul>
                         </div>
                         <div>
                            <strong class="block mb-1 text-slate-700 uppercase tracking-wide text-[10px]">Crit√©rios (Max 50)</strong>
                            <p>Assiduidade, Organiza√ß√£o, Participa√ß√£o,<br>Agilidade e Pontualidade.</p>
                            <p class="mt-1 text-slate-400">(Cada item vale 0, 5 ou 10 pts)</p>
                         </div>
                    </div>
                </section>

                <!-- Formul√°rio Lateral (ASIDE) -->
                <aside class="xl:col-span-1 no-print" data-html2canvas-ignore="true" aria-label="Formul√°rio de Lan√ßamento">
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm sticky top-24 overflow-hidden">
                        <div class="p-5 border-b border-gray-100 bg-gray-50">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i>
                                Lan√ßamento Manual
                            </h3>
                        </div>
                        <form onsubmit="addEmployee(event)" class="p-6 space-y-5">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Colaborador</label>
                                    <select id="empName" onchange="autoFillSalary()" required class="w-full p-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all cursor-pointer">
                                        <option value="">Selecione um colaborador...</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Sal√°rio (R$)</label>
                                        <input type="text" id="empSalary" required placeholder="0,00" oninput="formatCurrencyField(this)" class="w-full p-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Caixas</label>
                                        <input type="number" id="empBoxes" required placeholder="Qtd" oninput="updatePreview()" class="w-full p-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                                    </div>
                                </div>
                                <!-- NOVO CAMPO: Fator Individual -->
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Fator Individual (%) <span class="text-gray-300 font-normal normal-case">(Opcional)</span></label>
                                    <input type="number" id="empFactor" step="0.01" placeholder="Padr√£o Global" oninput="updatePreview()" class="w-full p-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                                    <p class="text-[10px] text-gray-400 mt-1">Preencha apenas se quiser uma % diferente para este funcion√°rio.</p>
                                </div>
                            </div>

                            <div class="pt-4 border-t border-gray-100">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-3">Avalia√ß√£o R√°pida</label>
                                <div class="space-y-2" id="criteriaList">
                                    <!-- Crit√©rios aqui -->
                                </div>
                            </div>

                            <div class="bg-blue-50 p-3 rounded-lg flex justify-between items-center text-blue-800 text-sm font-medium">
                                <span>Pontua√ß√£o Prevista:</span>
                                <!-- HTML5 OUTPUT -->
                                <output class="font-bold text-lg" id="previewPoints">0</output>
                            </div>

                            <button type="submit" id="addBtn" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-3.5 rounded-xl transition-all shadow-md active:scale-[0.98]">
                                Adicionar
                            </button>
                            <!-- Bot√£o cancelar edi√ß√£o (escondido por padr√£o) -->
                            <button type="button" id="cancelEditBtn" onclick="cancelEdit()" class="w-full bg-gray-200 hover:bg-gray-300 text-slate-700 font-bold py-3.5 rounded-xl transition-all hidden">
                                Cancelar Edi√ß√£o
                            </button>
                        </form>
                    </div>
                </aside>
            </div>

        </main>
    </div>

    <!-- TELA DE PREENCHIMENTO DIGITAL (Modal Fullscreen) -->
    <div id="digitalSheetModal" class="hidden fixed inset-0 bg-slate-100 z-50 overflow-y-auto no-print">
        <div class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
            <div class="flex flex-col md:flex-row items-center justify-between bg-white p-4 rounded-xl shadow-lg border border-slate-200 sticky top-4 z-20 gap-4">
                <div>
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                        <div class="p-1.5 bg-blue-100 rounded text-blue-600"><i data-lucide="monitor-check" class="w-5 h-5"></i></div>
                        Avalia√ß√£o Digital em Lote
                    </h2>
                    <p class="text-xs text-slate-500 mt-0.5">Realize o lan√ßamento das avalia√ß√µes e gere os relat√≥rios (CSV e PDF) para envio ao departamento respons√°vel.</p>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="closeDigitalSheet()" class="px-4 py-2 bg-gray-50 hover:bg-gray-100 text-slate-600 border border-gray-200 rounded-lg font-medium text-sm transition-colors">
                        Cancelar
                    </button>
                    <button onclick="exportDigitalSheetCSV()" class="px-4 py-2 bg-white border border-blue-200 text-blue-700 hover:bg-blue-50 rounded-lg font-medium text-sm transition-colors flex items-center gap-2">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> CSV
                    </button>
                    <button onclick="exportDigitalSheetPDF()" class="px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-medium text-sm transition-colors flex items-center gap-2 shadow-sm shadow-rose-200">
                        <i data-lucide="file-text" class="w-4 h-4"></i> PDF
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-3 bg-gray-50 border-b border-slate-200 text-center">
                    <div class="text-xs font-medium text-slate-500 bg-white inline-block px-3 py-1 rounded-full border border-gray-200 shadow-sm">
                        üí° Clique na nota para alternar: <span class="font-bold text-slate-300">0</span> ‚ûù <span class="font-bold text-amber-500">5</span> ‚ûù <span class="font-bold text-blue-600">10</span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm" id="digitalSheetTable">
                        <thead class="bg-white text-slate-500 border-b border-slate-200 uppercase text-xs font-semibold tracking-wide">
                            <tr>
                                <th class="p-4 min-w-[200px]">Funcion√°rio</th>
                                <th class="p-4 text-center w-20">Assid</th>
                                <th class="p-4 text-center w-20">Org</th>
                                <th class="p-4 text-center w-20">Part</th>
                                <th class="p-4 text-center w-20">Agil</th>
                                <th class="p-4 text-center w-20">Pont</th>
                                <th class="p-4 w-32">Caixas</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50 bg-slate-50/30"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL VER BASE DA EQUIPE -->
    <div id="viewTeamModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col animate-fade-in-up">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="database" class="w-5 h-5 text-blue-600"></i> Base de Equipe
                </h3>
                <button onclick="closeViewTeam()" class="text-slate-400 hover:text-slate-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-0 overflow-y-auto flex-1">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-slate-500 sticky top-0 text-xs uppercase font-semibold">
                        <tr>
                            <th class="p-4 border-b border-gray-100">Nome</th>
                            <th class="p-4 text-right border-b border-gray-100">Sal√°rio Base</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50" id="viewTeamTableBody"></tbody>
                </table>
            </div>
            <div class="p-3 bg-gray-50 text-center text-[10px] text-slate-400 border-t border-gray-100">
                Visualiza√ß√£o somente leitura. Contate o administrador para altera√ß√µes.
            </div>
        </div>
    </div>

    <!-- √ÅREA OCULTA PARA PDF -->
    <div id="manual-sheets-content" class="hidden bg-white min-h-screen p-8"></div>

    <!-- Scripts externos no final do body para n√£o bloquear renderiza√ß√£o -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        // --- JAVASCRIPT LOGIC ---
        let currentUser = null;
        let editingId = null; // Track which employee is being edited

        // ATEN√á√ÉO: Em produ√ß√£o, nunca armazene senhas no front-end.
        const users = {
            'alesandra': { pass: 'Spg1234@', role: 'admin', name: 'Alesandra' },
            'masterigl': { pass: 'Ghost2025', role: 'admin', name: 'MasterIGL' }, // Senha atualizada
            'fagner': { pass: 'brocolis2026', role: 'lider', name: 'Fagner' }
        };

        const INACTIVITY_LIMIT = 3600000; // 1 Hora em ms

        function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('loginUser').value.toLowerCase().trim();
            const pass = document.getElementById('loginPass').value;
            
            if (users[user] && users[user].pass === pass) {
                currentUser = users[user];
                localStorage.setItem('bonusApp_user', JSON.stringify(currentUser));
                localStorage.setItem('bonusApp_lastActive', Date.now());

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('userRoleDisplay').innerText = currentUser.name;
                
                applyUserRole(currentUser.role);
                lucide.createIcons();
                setupActivityListeners();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function handleLogout() { 
            localStorage.removeItem('bonusApp_user');
            localStorage.removeItem('bonusApp_lastActive');
            location.reload(); 
        }

        function checkAuth() {
            const storedUser = localStorage.getItem('bonusApp_user');
            const storedTime = localStorage.getItem('bonusApp_lastActive');
            
            if (storedUser && storedTime) {
                const now = Date.now();
                if (now - parseInt(storedTime) < INACTIVITY_LIMIT) {
                    currentUser = JSON.parse(storedUser);
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    document.getElementById('userRoleDisplay').innerText = currentUser.name;
                    applyUserRole(currentUser.role);
                    updateActivityTime();
                    setupActivityListeners();
                    lucide.createIcons();
                    setInterval(checkInactivity, 60000); 
                } else {
                    handleLogout();
                }
            }
        }
        
        function checkInactivity() {
            const lastActive = parseInt(localStorage.getItem('bonusApp_lastActive') || 0);
            if (Date.now() - lastActive > INACTIVITY_LIMIT) {
                handleLogout();
            }
        }

        function applyUserRole(role) {
            if (role === 'lider') {
                document.getElementById('admin-dashboard-content').classList.add('hidden');
                document.getElementById('leader-dashboard').classList.remove('hidden');
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden-force'));
            } else {
                document.getElementById('admin-dashboard-content').classList.remove('hidden');
                document.getElementById('leader-dashboard').classList.add('hidden');
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden-force'));
            }
        }

        function setupActivityListeners() {
            document.addEventListener('click', updateActivityTime);
            document.addEventListener('keypress', updateActivityTime);
            document.addEventListener('mousemove', updateActivityTime);
        }

        function updateActivityTime() {
            localStorage.setItem('bonusApp_lastActive', Date.now());
        }

        // --- CORE ---
        // Padr√£o 0.1 para que 1 ponto = 0.1% do sal√°rio. Logo, 10 pontos = 1% e 70 pontos = 7%.
        let config = JSON.parse(localStorage.getItem('bonusApp_config')) || { pointValue: 0.1, referenceMonth: new Date().toISOString().slice(0, 7) };
        let employees = JSON.parse(localStorage.getItem('bonusApp_employees')) || [];
        
        const teamDatabase = [
            { name: "EMANUEL CARDOSO ARAUJO", salary: 1621 },
            { name: "MARCOS FEITOSA DE OLIVEIRA", salary: 1621 },
            { name: "GABRIEL CARDOSO ARAUJO", salary: 1621 },
            { name: "FRANCISCO DA SILVA FERREIRA", salary: 1621 },
            { name: "LUCAS RIBEIRO DA SILVA", salary: 1621 },
            { name: "LEANDRO ALTINO FERREIRA", salary: 1621 },
            { name: "FELIPE BARBOSA BANDEIRA", salary: 1621 },
            { name: "ANTONIO PATRICK ARAUJO LEMOS", salary: 1621 },
            { name: "FABIANA MARQUES BARBOSA", salary: 1621 },
            { name: "BRUNA PEREIRA DA SILVA", salary: 1621 },
            { name: "MONICA BATISTA FARIAS", salary: 1621 },
            { name: "KARINE MARQUES DE ALMEIDA MARTINS", salary: 1621 },
            { name: "PEDRO LUCAS DE SOUZA GON√áALVES", salary: 1621 },
            { name: "GLAYLSON LIMA FERREIRA", salary: 1621 },
            { name: "DIONISIO PEREIRA DE ALBUQUERQUE", salary: 1621 }
        ];

        let newCriteria = { assiduity: 10, organization: 10, participation: 10, agility: 10, punctuality: 10 };
        const criteriaLabels = { assiduity: 'Assiduidade', organization: 'Organiza√ß√£o', participation: 'Participa√ß√£o', agility: 'Agilidade', punctuality: 'Pontualidade' };

        window.onload = function() {
            // CORRE√á√ÉO DO BUG: Verifica autentica√ß√£o ao carregar a p√°gina
            checkAuth();
            
            lucide.createIcons();
            document.getElementById('referenceMonth').value = config.referenceMonth;
            document.getElementById('pointValue').value = config.pointValue;
            updateTeamCountBadge();
            renderEmployeeSelect(); 
            renderCriteriaForm();
            renderAll();
        };

        function updateTeamCountBadge() {
            const badge = document.getElementById('teamCountBadge');
            if (badge) badge.innerText = teamDatabase.length;
        }

        function renderEmployeeSelect() {
            const select = document.getElementById('empName');
            const filterSelect = document.getElementById('filterEmployee');

            select.innerHTML = '<option value="">Selecione um colaborador...</option>';
            if(filterSelect) filterSelect.innerHTML = '<option value="">Todos</option>';
            
            teamDatabase.forEach(member => { 
                const opt = document.createElement('option'); 
                opt.value = member.name; 
                opt.text = member.name;
                select.appendChild(opt); 

                if(filterSelect) {
                    const optFilter = document.createElement('option');
                    optFilter.value = member.name;
                    optFilter.text = member.name;
                    filterSelect.appendChild(optFilter);
                }
            });
            updateTeamCountBadge();
        }

        function viewTeamDatabase() {
            const tbody = document.getElementById('viewTeamTableBody');
            tbody.innerHTML = '';
            teamDatabase.forEach(member => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-4 font-medium text-slate-700">${member.name}</td><td class="p-4 text-right font-mono text-slate-600">${formatCurrency(member.salary)}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('viewTeamModal').classList.remove('hidden');
            lucide.createIcons();
        }
        function closeViewTeam() { document.getElementById('viewTeamModal').classList.add('hidden'); }

        // --- AUTOCOMPLETE SALARY ---
        function autoFillSalary() {
            const select = document.getElementById('empName');
            const salaryInput = document.getElementById('empSalary');
            const selectedName = select.value;
            
            const member = teamDatabase.find(m => m.name === selectedName);
            if (member) {
                salaryInput.value = formatCurrencyValue(member.salary);
            } else {
                 salaryInput.value = "";
            }
        }
        
        function formatCurrencyValue(value) {
            return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatCurrencyField(input) {
            let value = input.value.replace(/\D/g, '');
            value = (parseInt(value) / 100).toFixed(2) + '';
            value = value.replace('.', ',');
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            if (value === 'NaN') value = '';
            input.value = value;
        }
        
        function parseCurrency(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.'));
        }

        function getProductionPoints(boxes) {
            if (boxes < 200) return 0;
            if (boxes <= 400) return 20;
            if (boxes <= 600) return 30;
            if (boxes <= 800) return 50;
            return 60;
        }

        function calculateBonus(emp) {
            const prodPts = getProductionPoints(emp.boxes || 0);
            const perfPts = Object.values(emp.criteria).reduce((a, b) => a + Number(b), 0);
            const totalPts = prodPts + perfPts;
            
            // L√ìGICA ATUALIZADA: Prioriza fator individual se existir
            let factor = config.pointValue;
            if (emp.customFactor !== undefined && emp.customFactor !== null && emp.customFactor !== "") {
                factor = parseFloat(emp.customFactor);
            }
            
            // Ex: 70 pontos * 0.1 (fator) = 7%
            const bonusPercentage = totalPts * factor; 
            
            const salary = Number(emp.salary) || 0;
            const bonusVal = salary * (bonusPercentage / 100);
            
            return { prodPts, perfPts, totalPts, bonusPercentage, bonusVal, totalReceive: salary + bonusVal };
        }

        function formatCurrency(val) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0); }

        function updateConfig(key, value) {
            config[key] = value;
            localStorage.setItem('bonusApp_config', JSON.stringify(config));
            renderAll();
        }

        function saveData() { localStorage.setItem('bonusApp_employees', JSON.stringify(employees)); renderAll(); }

        function resetData() { 
            if(confirm("Apagar todos os dados da planilha atual?")) { 
                localStorage.removeItem('bonusApp_employees'); 
                employees = [];
                renderAll();
            } 
        }

        function toggleSettings() { 
            document.getElementById('settingsPanel').classList.toggle('hidden'); 
        }
        function updateTitle() { renderAll(); }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { processCSV(e.target.result); };
            reader.readAsText(file);
            event.target.value = '';
        }

        function processCSV(text) {
            const lines = text.split('\n');
            if (lines.length < 2) return alert("Arquivo vazio.");
            const header = lines[0];
            let sep = header.includes(';') ? ';' : ',';
            const hasMonthCol = header.toLowerCase().includes('m√™s') || header.toLowerCase().includes('mes');
            const nameIdx = hasMonthCol ? 1 : 0;
            const salaryIdx = nameIdx + 1;
            const boxesIdx = nameIdx + 2;
            const critStartIdx = nameIdx + 3; 
            let newCount = 0;
            let detectedDate = null; // Vari√°vel para armazenar a data detectada

            const rows = lines.slice(1);
            rows.forEach(row => {
                if(!row.trim()) return;
                const cols = row.split(sep).map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length < 3) return;
                
                // Tenta detectar a data da primeira linha v√°lida se houver coluna de m√™s
                if (hasMonthCol && !detectedDate && cols[0].includes('/')) {
                    detectedDate = cols[0]; 
                }

                const name = cols[nameIdx];
                let salary = 1621;
                if (cols[salaryIdx]) {
                    const sStr = cols[salaryIdx].replace('R$','').replace('.','').replace(',','.');
                    if (!isNaN(parseFloat(sStr))) salary = parseFloat(sStr);
                } else {
                    const dbMember = teamDatabase.find(m => m.name === name);
                    if (dbMember) salary = dbMember.salary;
                }
                const boxes = parseInt(cols[boxesIdx]) || 0;
                
                // Helper to safely parse criteria allowing 0
                const parseCrit = (val) => {
                    if (val === undefined || val === null || val.trim() === '') return 10;
                    const n = parseInt(val);
                    return isNaN(n) ? 10 : n;
                };

                const crit = { 
                    assiduity: parseCrit(cols[critStartIdx]), 
                    organization: parseCrit(cols[critStartIdx+1]), 
                    participation: parseCrit(cols[critStartIdx+2]), 
                    agility: parseCrit(cols[critStartIdx+3]), 
                    punctuality: parseCrit(cols[critStartIdx+4]) 
                };
                if (name) { 
                    employees.push({ id: Date.now()+Math.random(), name: name, salary: salary, boxes: boxes, criteria: crit }); 
                    newCount++; 
                }
            });

            // L√≥gica para atualizar o m√™s de refer√™ncia automaticamente
            if (detectedDate) {
                try {
                    const [monthName, year] = detectedDate.split('/');
                    const monthsMap = {
                        'janeiro': '01', 'fevereiro': '02', 'mar√ßo': '03', 'marco': '03', 'abril': '04',
                        'maio': '05', 'junho': '06', 'julho': '07', 'agosto': '08',
                        'setembro': '09', 'outubro': '10', 'novembro': '11', 'dezembro': '12'
                    };
                    const mKey = monthName.toLowerCase().trim();
                    if (monthsMap[mKey] && year) {
                        const newRef = `${year.trim()}-${monthsMap[mKey]}`;
                        // Atualiza a config e o input visualmente
                        updateConfig('referenceMonth', newRef);
                        document.getElementById('referenceMonth').value = newRef;
                    }
                } catch (e) {
                    console.error("Erro ao detectar data do CSV", e);
                }
            }

            saveData(); alert(`${newCount} registros importados! M√™s ajustado.`);
        }

        function exportToCSV() {
            if (employees.length === 0) return alert("N√£o h√° dados para exportar.");
            // Admin: Exporta SEM o sufixo _CSV
            generateAndDownloadCSV(employees, "Geral", false);
        }

        // Fun√ß√£o atualizada para aceitar o par√¢metro 'includeSuffix'
        function generateAndDownloadCSV(dataList, suffix, includeSuffix = false) {
            let csvContent = "\uFEFF"; 
            csvContent += "M√™s Refer√™ncia;Nome;Sal√°rio Base;Caixas;Assiduidade;Organiza√ß√£o;Participa√ß√£o;Agilidade;Pontualidade;Total Pontos;Valor B√¥nus;Total a Receber\n";
            let monthLabel = "N√£o definido";
            if (config.referenceMonth) {
                const [y, m] = config.referenceMonth.split('-');
                const mn = new Date(y, m - 1).toLocaleString('pt-BR', { month: 'long' });
                monthLabel = `${mn.charAt(0).toUpperCase() + mn.slice(1)}/${y}`;
            }
            dataList.forEach(emp => {
                const calc = calculateBonus(emp);
                const c = emp.criteria;
                const row = [
                    monthLabel,
                    emp.name,
                    emp.salary.toFixed(2).replace('.', ','),
                    emp.boxes,
                    c.assiduity,
                    c.organization,
                    c.participation,
                    c.agility,
                    c.punctuality,
                    calc.totalPts,
                    calc.bonusVal.toFixed(2).replace('.', ','),
                    calc.totalReceive.toFixed(2).replace('.', ',')
                ];
                csvContent += row.join(";") + "\n";
            });
            
            // L√≥gica de nome do arquivo din√¢mica
            let filename = `Bonus_${suffix}${includeSuffix ? '_CSV' : ''}.csv`;
            
            if (config.referenceMonth) {
                const [y, m] = config.referenceMonth.split('-');
                const mn = new Date(y, m - 1).toLocaleString('pt-BR', { month: 'long' });
                const monthCap = mn.charAt(0).toUpperCase() + mn.slice(1);
                
                // Se includeSuffix for true (L√≠der), adiciona _CSV. Se false (Admin), n√£o adiciona.
                filename = `Bonus_${monthCap}_${y}${includeSuffix ? '_CSV' : ''}.csv`;
            }
            
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function renderAll() {
            const tbody = document.getElementById('employeesTableBody');
            tbody.innerHTML = '';
            let totalBonus = 0;
            
            // APPLY FILTER
            const filterName = document.getElementById('filterEmployee').value;
            
            if (config.referenceMonth) {
                const [y, m] = config.referenceMonth.split('-');
                const mn = new Date(y, m - 1).toLocaleString('pt-BR', { month: 'long' });
                document.getElementById('headerTitle').innerText = `Relat√≥rio de B√¥nus - ${mn.charAt(0).toUpperCase() + mn.slice(1)} de ${y}`;
            }

            // Filtrar empregados
            let displayedEmployees = employees;
            if (filterName) {
                displayedEmployees = employees.filter(e => e.name === filterName);
            }

            if (displayedEmployees.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="12" class="p-8 text-center text-slate-400 italic">Nenhum registro encontrado.</td></tr>';
            } else {
                displayedEmployees.forEach(emp => {
                    const calc = calculateBonus(emp);
                    totalBonus += calc.bonusVal;
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-colors group";
                    tr.innerHTML = `
                        <td class="p-4 font-medium text-slate-800">${emp.name}<div class="text-xs text-slate-400 font-normal">Base: ${formatCurrency(emp.salary)}</div></td>
                        <td class="p-4 text-center text-slate-600">${emp.boxes}</td>
                        <td class="p-4 text-center"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded-md text-xs font-bold">${calc.prodPts}</span></td>
                        <td class="p-2 text-center text-xs text-slate-500">${emp.criteria.assiduity}</td>
                        <td class="p-2 text-center text-xs text-slate-500">${emp.criteria.organization}</td>
                        <td class="p-2 text-center text-xs text-slate-500">${emp.criteria.participation}</td>
                        <td class="p-2 text-center text-xs text-slate-500">${emp.criteria.agility}</td>
                        <td class="p-2 text-center text-xs text-slate-500">${emp.criteria.punctuality}</td>
                        <td class="p-4 text-center font-bold text-slate-700">
                            ${calc.totalPts}
                            <div class="text-[10px] text-blue-600 bg-blue-50 rounded px-1 mt-1 font-bold inline-block">${calc.bonusPercentage.toFixed(1)}%</div>
                        </td>
                        <td class="p-4 text-right font-bold text-emerald-600">+ ${formatCurrency(calc.bonusVal)}</td>
                        <td class="p-4 text-right font-bold text-slate-900">${formatCurrency(calc.totalReceive)}</td>
                        <td class="p-4 text-right no-print flex justify-end gap-2" data-html2canvas-ignore="true">
                            <button onclick="editEmployee(${emp.id})" class="text-slate-300 hover:text-blue-500 transition-colors" title="Editar">
                                <i data-lucide="pencil" width="16"></i>
                            </button>
                            <button onclick="removeEmployee(${emp.id})" class="text-slate-300 hover:text-red-500 transition-colors" title="Excluir">
                                <i data-lucide="trash-2" width="16"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // Update Totals (based on current view)
            let viewTotalBonus = 0;
            displayedEmployees.forEach(e => viewTotalBonus += calculateBonus(e).bonusVal);
            
            document.getElementById('totalBonusDisplay').innerText = formatCurrency(viewTotalBonus);
            document.getElementById('totalEmployeesDisplay').innerText = displayedEmployees.length;
            lucide.createIcons();
            
            // Populate filter if empty
            const filterSelect = document.getElementById('filterEmployee');
            
            if (filterSelect.options.length <= 1) {
                teamDatabase.forEach(member => {
                    const opt = document.createElement('option');
                    opt.value = member.name;
                    opt.text = member.name;
                    filterSelect.appendChild(opt);
                });
            }
        }

        function renderCriteriaForm() {
            const c = document.getElementById('criteriaList'); c.innerHTML = '';
            Object.keys(criteriaLabels).forEach(key => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-white p-2 rounded-lg border border-gray-100";
                const v = newCriteria[key];
                div.innerHTML = `<span class="text-xs font-semibold text-slate-600">${criteriaLabels[key]}</span>
                    <div class="flex gap-1.5">
                        <button type="button" onclick="setCriteria('${key}', 0)" class="w-8 h-7 rounded border text-[10px] font-bold transition-all ${v===0?'bg-rose-100 text-rose-700 border-rose-300':'bg-gray-50 text-slate-400 border-gray-200 hover:bg-gray-100'}">0</button>
                        <button type="button" onclick="setCriteria('${key}', 5)" class="w-8 h-7 rounded border text-[10px] font-bold transition-all ${v===5?'bg-amber-100 text-amber-700 border-amber-300':'bg-gray-50 text-slate-400 border-gray-200 hover:bg-gray-100'}">5</button>
                        <button type="button" onclick="setCriteria('${key}', 10)" class="w-8 h-7 rounded border text-[10px] font-bold transition-all ${v===10?'bg-blue-100 text-blue-700 border-blue-300':'bg-gray-50 text-slate-400 border-gray-200 hover:bg-gray-100'}">10</button>
                    </div>`;
                c.appendChild(div);
            });
            updatePreview();
        }

        function setCriteria(key, val) { newCriteria[key] = val; renderCriteriaForm(); }
        function updatePreview() {
            const b = Number(document.getElementById('empBoxes').value) || 0;
            const points = getProductionPoints(b) + Object.values(newCriteria).reduce((a,b)=>a+b,0);
            
            // Preview considera o campo individual se preenchido
            const customInput = document.getElementById('empFactor').value;
            const factor = (customInput && !isNaN(parseFloat(customInput))) ? parseFloat(customInput) : config.pointValue;
            
            const percent = points * factor;
            document.getElementById('previewPoints').innerText = `${points} pts (${percent.toFixed(1)}%)`;
        }

        // --- EDIT FUNCTIONALITY ---
        function editEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;

            const select = document.getElementById('empName');
            select.value = emp.name;
            
            document.getElementById('empSalary').value = formatCurrencyValue(emp.salary);
            document.getElementById('empBoxes').value = emp.boxes;
            
            // Carrega o fator individual se existir
            document.getElementById('empFactor').value = emp.customFactor !== undefined ? emp.customFactor : "";
            
            newCriteria = { ...emp.criteria };
            renderCriteriaForm();
            updatePreview();
            
            editingId = id;
            
            const addBtn = document.getElementById('addBtn');
            addBtn.innerHTML = 'Atualizar';
            addBtn.classList.remove('bg-slate-900', 'hover:bg-black');
            addBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('empName').focus();
        }

        function cancelEdit() {
            editingId = null;
            document.getElementById('empName').value = "";
            document.getElementById('empSalary').value = "";
            document.getElementById('empBoxes').value = "";
            document.getElementById('empFactor').value = ""; // Limpa o campo
            newCriteria = { assiduity: 10, organization: 10, participation: 10, agility: 10, punctuality: 10 };
            renderCriteriaForm();
            updatePreview();
            
            const addBtn = document.getElementById('addBtn');
            addBtn.innerHTML = 'Adicionar';
            addBtn.classList.add('bg-slate-900', 'hover:bg-black');
            addBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        function addEmployee(e) {
            e.preventDefault();
            const name = document.getElementById('empName').value;
            const salary = parseCurrency(document.getElementById('empSalary').value);
            const boxes = document.getElementById('empBoxes').value;
            const customFactor = document.getElementById('empFactor').value; // Captura o valor
            
            if(!name || isNaN(salary)) return alert("Por favor, preencha o nome e o sal√°rio corretamente.");
            
            if (editingId) {
                const index = employees.findIndex(e => e.id === editingId);
                if (index !== -1) {
                    employees[index] = { 
                        id: editingId, 
                        name, 
                        salary: salary, 
                        boxes: Number(boxes), 
                        customFactor: customFactor, // Salva no objeto
                        criteria: {...newCriteria} 
                    };
                }
                cancelEdit(); 
            } else {
                employees.push({ 
                    id: Date.now(), 
                    name, 
                    salary: salary, 
                    boxes: Number(boxes), 
                    customFactor: customFactor, // Salva no objeto
                    criteria: {...newCriteria} 
                });
                
                document.getElementById('empName').value = ''; 
                document.getElementById('empSalary').value = ''; 
                document.getElementById('empBoxes').value = '';
                document.getElementById('empFactor').value = '';
                newCriteria = { assiduity: 10, organization: 10, participation: 10, agility: 10, punctuality: 10 };
                renderCriteriaForm(); 
            }
            saveData();
        }

        function removeEmployee(id) { if(confirm("Remover?")) { employees = employees.filter(e => e.id !== id); saveData(); } }

        function openDigitalSheet() {
            // --- VALIDA√á√ÉO DE SEGURAN√áA (NOVA) ---
            const refMonthInput = document.getElementById('referenceMonth');
            const refMonthValue = refMonthInput.value;

            if (!refMonthValue) {
                alert("‚ö†Ô∏è ATEN√á√ÉO: Selecione o M√™s e Ano da avalia√ß√£o antes de continuar!");
                // Efeito visual para destacar o erro
                refMonthInput.parentElement.classList.add('ring-4', 'ring-red-500', 'bg-red-50');
                refMonthInput.focus();
                setTimeout(() => refMonthInput.parentElement.classList.remove('ring-4', 'ring-red-500', 'bg-red-50'), 2000);
                return;
            }

            // Confirma√ß√£o expl√≠cita da data
            const [year, month] = refMonthValue.split('-');
            const monthName = new Date(year, month - 1).toLocaleString('pt-BR', { month: 'long' });
            const formattedDate = `${monthName.toUpperCase()} DE ${year}`;

            if (!confirm(`CONFIRMA√á√ÉO DE PER√çODO:\n\nVoc√™ est√° prestes a iniciar a avalia√ß√£o referente a:\nüìÖ ${formattedDate}\n\nEst√° correto?`)) {
                return; // Cancela se o usu√°rio clicar em "Cancelar"
            }
            // --------------------------------------

            if (teamDatabase.length === 0) {
                alert("Sua base de equipe est√° vazia. Adicione funcion√°rios em 'Equipe' primeiro.");
                return;
            }
            const modal = document.getElementById('digitalSheetModal');
            const tbody = document.querySelector('#digitalSheetTable tbody');
            tbody.innerHTML = '';
            teamDatabase.forEach((member, index) => {
                const existing = employees.find(e => e.name === member.name);
                const boxes = existing ? existing.boxes : '';
                const crit = existing ? existing.criteria : { assiduity: 0, organization: 0, participation: 0, agility: 0, punctuality: 0 };
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50/50 transition-colors";
                let criteriaHtml = '';
                Object.keys(criteriaLabels).forEach(key => {
                    const val = crit[key];
                    let btnClass = "bg-white text-slate-300 border-gray-200 hover:border-gray-300"; 
                    if(val === 0) btnClass = "bg-rose-100 text-rose-700 border-rose-300 ring-2 ring-rose-100";
                    if(val === 5) btnClass = "bg-amber-100 text-amber-700 border-amber-300 ring-2 ring-amber-100";
                    if(val === 10) btnClass = "bg-blue-100 text-blue-700 border-blue-300 ring-2 ring-blue-100";

                    criteriaHtml += `<td class="p-4 text-center"><button type="button" onclick="toggleDigitalCriteria(this)" data-value="${val}" class="w-9 h-9 rounded-full font-bold text-xs border transition-all ${btnClass}">${val}</button><input type="hidden" name="crit_${index}_${key}" value="${val}"></td>`;
                });
                tr.innerHTML = `<td class="p-4 font-medium text-slate-800">${member.name}<input type="hidden" name="name_${index}" value="${member.name}"></td>${criteriaHtml}<td class="p-4"><input type="number" name="boxes_${index}" value="${boxes}" placeholder="0" class="w-full p-2 border border-gray-200 rounded-lg text-center focus:ring-2 focus:ring-blue-500 outline-none transition-all"></td>`;
                tbody.appendChild(tr);
            });
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeDigitalSheet() { document.getElementById('digitalSheetModal').classList.add('hidden'); }

        function toggleDigitalCriteria(btn) {
            const current = parseInt(btn.getAttribute('data-value'));
            const input = btn.nextElementSibling;
            let nextVal = 0;
            let nextClass = "bg-white text-slate-300 border-gray-200 hover:border-gray-300";

            if (current === 0) {
                nextVal = 5;
                nextClass = "bg-amber-100 text-amber-700 border-amber-300 ring-2 ring-amber-100";
            } else if (current === 5) {
                nextVal = 10;
                nextClass = "bg-blue-100 text-blue-700 border-blue-300 ring-2 ring-blue-100";
            } else {
                nextVal = 0;
                nextClass = "bg-rose-100 text-rose-700 border-rose-300 ring-2 ring-rose-100";
            }
            
            btn.setAttribute('data-value', nextVal);
            btn.innerText = nextVal;
            btn.className = `w-9 h-9 rounded-full font-bold text-xs border transition-all ${nextClass}`;
            input.value = nextVal;
        }

        function exportDigitalSheetCSV() {
            const tempEmployees = [];
            const tbody = document.querySelector('#digitalSheetTable tbody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const name = row.querySelector(`input[name="name_${index}"]`).value;
                const boxes = row.querySelector(`input[name="boxes_${index}"]`).value;
                const dbMember = teamDatabase.find(m => m.name === name);
                const salary = dbMember ? dbMember.salary : 1621;
                const criteria = {};
                Object.keys(criteriaLabels).forEach(key => criteria[key] = parseInt(row.querySelector(`input[name="crit_${index}_${key}"]`).value));
                tempEmployees.push({ id: Date.now(), name: name, salary: Number(salary), boxes: Number(boxes) || 0, criteria: criteria });
            });
            generateAndDownloadCSV(tempEmployees, "Preenchido");
        }

        function exportDigitalSheetPDF() {
             const container = document.getElementById('manual-sheets-content');
             const modal = document.getElementById('digitalSheetModal');
             const appContent = document.getElementById('app-content');
             
             container.innerHTML = '';
             let titleSuffix = config.referenceMonth ? ` - ${new Date(config.referenceMonth.split('-')[0], config.referenceMonth.split('-')[1] - 1).toLocaleString('pt-BR', { month: 'long' })}` : "";
             
             const tbody = document.querySelector('#digitalSheetTable tbody');
             const rows = tbody.querySelectorAll('tr');
             let rowsHtml = '';
             
             rows.forEach((row, index) => {
                 const name = row.querySelector(`input[name="name_${index}"]`).value;
                 const boxes = row.querySelector(`input[name="boxes_${index}"]`).value || '0';
                 let criteriaCells = '';
                 Object.keys(criteriaLabels).forEach(key => criteriaCells += `<td style="border: 1px solid #e2e8f0; padding: 8px; text-align: center;">${row.querySelector(`input[name="crit_${index}_${key}"]`).value}</td>`);
                 rowsHtml += `<tr style="background-color: #fff;"><td style="border: 1px solid #e2e8f0; padding: 10px; font-weight: bold; color: #1e293b;">${name}</td>${criteriaCells}<td style="border: 1px solid #e2e8f0; padding: 10px; text-align: center;">${boxes}</td></tr>`;
             });
             
             container.innerHTML = `
                <div style="font-family: 'Inter', sans-serif; color: #333; width: 100%; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #2563eb; padding-bottom: 10px;">
                        <h1 style="font-size: 20px; font-weight: bold; color: #2563eb;">Relat√≥rio de Avalia√ß√£o Digital${titleSuffix}</h1>
                        <p style="color: #64748b; font-size: 12px;">${new Date().toLocaleDateString('pt-BR')}</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead><tr style="background-color: #f8fafc; color: #475569;"><th style="border: 1px solid #e2e8f0; padding: 12px; width: 25%;">FUNCION√ÅRIO</th>${['ASSID','ORG','PART','AGIL','PONT'].map(l=>`<th style="border: 1px solid #e2e8f0; padding: 8px; text-align: center;">${l}</th>`).join('')}<th style="border: 1px solid #e2e8f0; padding: 12px; width: 10%;">CAIXAS</th></tr></thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                     <div style="margin-top: 20px; font-size: 10px; color: #94a3b8; text-align: right;">
                        * Documento gerado digitalmente.
                    </div>
                </div>
             `;
             
             const btn = document.querySelector('button[onclick="exportDigitalSheetPDF()"]');
             const originalText = btn.innerHTML;
             btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
             lucide.createIcons();
             
             const scrollY = window.scrollY;
             appContent.style.display = 'none';
             modal.classList.add('hidden'); 
             container.classList.remove('hidden');
             container.style.width = '1100px'; container.style.margin = '0 auto';
             window.scrollTo(0,0);

             setTimeout(() => {
                 // Define o nome do arquivo dinamicamente
                 let filename = 'Relatorio_Digital.pdf';
                 if (config.referenceMonth) {
                    const [y, m] = config.referenceMonth.split('-');
                    const mn = new Date(y, m - 1).toLocaleString('pt-BR', { month: 'long' });
                    const monthCap = mn.charAt(0).toUpperCase() + mn.slice(1);
                    // Formato: Bonus_Mes_Ano_PDF.pdf
                    filename = `Bonus_${monthCap}_${y}_PDF.pdf`;
                 }

                 const contentHeight = container.scrollHeight;
                 const contentWidth = container.scrollWidth;
                 const opt = { margin: 10, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'px', format: [contentWidth + 20, contentHeight + 20], orientation: contentWidth > contentHeight ? 'landscape' : 'portrait' } };
                 html2pdf().set(opt).from(container).save().then(() => {
                     container.classList.add('hidden');
                     appContent.style.display = 'block';
                     modal.classList.remove('hidden');
                     btn.innerHTML = originalText;
                     window.scrollTo(0, scrollY);
                 }).catch(err => {
                     console.error(err);
                     alert("Erro ao gerar PDF.");
                     container.classList.add('hidden');
                     appContent.style.display = 'block';
                     modal.classList.remove('hidden');
                     btn.innerHTML = originalText;
                 });
             }, 500);
        }

        // --- ORIGINAL PDF GENERATION ---
        function downloadManualSheets() {
            const container = document.getElementById('manual-sheets-content');
            const btn = document.querySelector('button[onclick="downloadManualSheets()"]');
            const originalText = btn.innerHTML;
            container.innerHTML = '';
            let titleSuffix = config.referenceMonth ? ` - ${new Date(config.referenceMonth.split('-')[0], config.referenceMonth.split('-')[1] - 1).toLocaleString('pt-BR', { month: 'long' })}` : "";
            let rows = '';
            let list = teamDatabase;
            if (list.length === 0) for(let i=0; i<15; i++) rows += generateRowHTML({ name: "" });
            else { list.forEach(emp => rows += generateRowHTML(emp)); for(let i=0; i<3; i++) rows += generateRowHTML({ name: "" }); }
            container.innerHTML = `<div style="font-family: 'Inter', sans-serif; color: #333; width: 100%; padding: 20px;"><div style="display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #2563eb; padding-bottom: 10px;"><h1 style="font-size: 20px; font-weight: bold; color: #2563eb;">Ficha de Avalia√ß√£o Mensal${titleSuffix}</h1><p style="color: #64748b; font-size: 12px;">${new Date().toLocaleDateString('pt-BR')}</p></div><table style="width: 100%; border-collapse: collapse; font-size: 11px;"><thead><tr style="background-color: #f8fafc; color: #475569;"><th style="border: 1px solid #e2e8f0; padding: 12px; width: 25%;">FUNCION√ÅRIO</th>${['ASSID','ORG','PART','AGIL','PONT'].map(l=>`<th style="border: 1px solid #e2e8f0; padding: 8px;">${l}</th>`).join('')}<th style="border: 1px solid #e2e8f0; padding: 12px; width: 10%;">CAIXAS</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            btn.innerHTML = 'Gerando...';
            const app = document.getElementById('app-content');
            const scroll = window.scrollY;
            app.style.display = 'none';
            container.classList.remove('hidden');
            container.style.width = '1122px'; // A4 LANDSCAPE WIDTH
            container.style.margin = '0 auto';
            window.scrollTo(0,0);
            
            setTimeout(() => {
                const contentHeight = container.scrollHeight;
                const contentWidth = container.scrollWidth;
                const opt = { margin: [2, 2, 2, 2], filename: 'Ficha_Avaliacao.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'px', format: [contentWidth+20, contentHeight+20], orientation: contentWidth > contentHeight ? 'l' : 'p' } };
                html2pdf().set(opt).from(container).save().then(() => {
                    container.classList.add('hidden');
                    app.style.display = 'block';
                    btn.innerHTML = originalText;
                    window.scrollTo(0, scroll);
                });
            }, 300);
        }

        function generateRowHTML(emp) {
            if (!emp.name) return '';
            const nameCell = `<span style="font-size: 13px; font-weight: 600; color: #1e293b;">${emp.name}</span>`;
            const criteriaCells = Array(5).fill(0).map(() => `<td style="border: 1px solid #e2e8f0; padding: 8px; text-align: center;"><div style="display: flex; justify-content: center; gap: 15px;"><div style="display: flex; align-items: center; gap: 4px;"><div style="width: 14px; height: 14px; border: 1px solid #94a3b8; border-radius: 3px;"></div><span style="color: #64748b; font-size: 10px;">5</span></div><div style="display: flex; align-items: center; gap: 4px;"><div style="width: 14px; height: 14px; border: 1px solid #94a3b8; border-radius: 3px;"></div><span style="color: #64748b; font-size: 10px;">10</span></div></div></td>`).join('');
            return `<tr style="border-bottom: 1px solid #e2e8f0;"><td style="border: 1px solid #e2e8f0; padding: 10px;">${nameCell}</td>${criteriaCells}<td style="border: 1px solid #e2e8f0; padding: 10px;"></td></tr>`;
        }

        // --- NOVA FUN√á√ÉO: Tabela Simples Estilo Excel ---
        function printSimpleTable() {
            const container = document.getElementById('manual-sheets-content');
            const btn = document.querySelector('button[onclick="printSimpleTable()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
            lucide.createIcons();

            container.innerHTML = '';
            
            // T√≠tulo e Data
            let titleSuffix = config.referenceMonth ? ` - ${new Date(config.referenceMonth.split('-')[0], config.referenceMonth.split('-')[1] - 1).toLocaleString('pt-BR', { month: 'long' })}` : "";
            if(config.referenceMonth) {
                const [y, m] = config.referenceMonth.split('-');
                titleSuffix = ` - ${m}/${y}`;
            }

            // Cabe√ßalho da Tabela
            let tableHtml = `
                <div style="font-family: Arial, sans-serif; padding: 20px; color: #000;">
                    <div style="margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 18px; text-transform: uppercase;">Relat√≥rio de B√¥nus${titleSuffix}</h2>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Gerado em ${new Date().toLocaleDateString('pt-BR')}</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background-color: #e0e0e0;">
                                <th style="border: 1px solid #000; padding: 6px; text-align: left;">FUNCION√ÅRIO</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: center;">CAIXAS</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: center;">PROD.</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: center;">ASSID</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: center;">ORG</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: center;">PART</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: center;">AGIL</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: center;">PONT</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: center;">TOTAL PTS</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: right;">B√îNUS</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: right;">A RECEBER</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Linhas da Tabela
            let totalBonusSum = 0;
            let totalReceiveSum = 0; // Vari√°vel para somar o Total a Receber
            
            // Aplicar filtro se houver
            const filterName = document.getElementById('filterEmployee').value;
            let listToPrint = employees;
            if (filterName) {
                listToPrint = employees.filter(e => e.name === filterName);
            }

            listToPrint.forEach(emp => {
                const calc = calculateBonus(emp);
                totalBonusSum += calc.bonusVal;
                totalReceiveSum += calc.totalReceive; // Somando valor a receber
                
                tableHtml += `
                    <tr>
                        <td style="border: 1px solid #000; padding: 5px;">${emp.name}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">${emp.boxes}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">${calc.prodPts}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">${emp.criteria.assiduity}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">${emp.criteria.organization}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">${emp.criteria.participation}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">${emp.criteria.agility}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center;">${emp.criteria.punctuality}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: center; font-weight: bold;">
                            ${calc.totalPts} <span style="font-size: 9px; color: #666;">(${calc.bonusPercentage.toFixed(1)}%)</span>
                        </td>
                        <!-- Formatado em Moeda -->
                        <td style="border: 1px solid #000; padding: 5px; text-align: right;">${formatCurrency(calc.bonusVal)}</td>
                        <td style="border: 1px solid #000; padding: 5px; text-align: right; font-weight: bold;">${formatCurrency(calc.totalReceive)}</td>
                    </tr>
                `;
            });

            // Rodap√© com totais
            tableHtml += `
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f0f0f0; font-weight: bold;">
                                <td colspan="9" style="border: 1px solid #000; padding: 6px; text-align: right;">TOTAL GERAL:</td>
                                <!-- Formatado em Moeda -->
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${formatCurrency(totalBonusSum)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${formatCurrency(totalReceiveSum)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;

            const app = document.getElementById('app-content');
            const scroll = window.scrollY;
            app.style.display = 'none';
            container.classList.remove('hidden');
            container.style.width = '1100px'; 
            container.style.margin = '0 auto';
            window.scrollTo(0,0);

            setTimeout(() => {
                // Nome do arquivo
                let filename = 'Relatorio_Simples.pdf';
                if (config.referenceMonth) {
                    const [y, m] = config.referenceMonth.split('-');
                    const mn = new Date(y, m - 1).toLocaleString('pt-BR', { month: 'long' });
                    const monthCap = mn.charAt(0).toUpperCase() + mn.slice(1);
                    filename = `Bonus_${monthCap}_${y}_Tabela.pdf`;
                }

                const contentHeight = container.scrollHeight;
                const contentWidth = container.scrollWidth;
                
                const opt = { 
                    margin: 10, 
                    filename: filename, 
                    image: { type: 'jpeg', quality: 0.98 }, 
                    html2canvas: { scale: 2, useCORS: true }, 
                    jsPDF: { unit: 'px', format: [contentWidth + 20, contentHeight + 20], orientation: 'landscape' } 
                };
                
                html2pdf().set(opt).from(container).save().then(() => {
                    container.classList.add('hidden');
                    app.style.display = 'block';
                    btn.innerHTML = originalText;
                    window.scrollTo(0, scroll);
                }).catch(err => {
                    console.error(err);
                    alert("Erro ao gerar PDF.");
                    container.classList.add('hidden');
                    app.style.display = 'block';
                    btn.innerHTML = originalText;
                });
            }, 500);
        }

        function downloadPDF() {
            const el = document.getElementById('app-content');
            let fn = "Relatorio.pdf";
            if(config.referenceMonth) { const [y,m]=config.referenceMonth.split('-'); const mn=new Date(y,m-1).toLocaleString('pt-BR',{month:'long'}); fn=`Relat√≥rio de B√¥nus - ${mn.charAt(0).toUpperCase()+mn.slice(1)} de ${y}.pdf`; }
            const btn = document.querySelector('button[onclick="downloadPDF()"]'); const txt = btn.innerHTML; btn.innerHTML = "Gerando...";
            
            // Salva estilos originais
            const originalWidth = el.style.width;
            const originalMargin = el.style.margin;
            const originalPadding = el.style.padding;
            
            // Permite que o elemento cres√ßa o quanto precisar horizontalmente
            el.style.width = 'fit-content'; 
            el.style.minWidth = '100%'; 
            el.style.margin = '0';
            el.style.padding = '20px'; 
            
            setTimeout(() => {
                // Captura as dimens√µes reais do conte√∫do expandido
                const contentWidth = el.scrollWidth; 
                const contentHeight = el.scrollHeight;

                const opt = { 
                    margin: 10, 
                    filename: fn, 
                    image: { type: 'jpeg', quality: 0.98 }, 
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true
                    }, 
                    jsPDF: { 
                        unit: 'px', 
                        // Define o tamanho da folha PDF igual ao tamanho do conte√∫do (+ margem)
                        // Isso remove qualquer limite de largura A4
                        format: [contentWidth + 40, contentHeight + 40], 
                        orientation: contentWidth > contentHeight ? 'landscape' : 'portrait' 
                    } 
                };
                
                html2pdf().set(opt).from(el).save().then(() => {
                    // Restaura
                    el.style.width = originalWidth;
                    el.style.margin = originalMargin;
                    el.style.padding = originalPadding;
                    btn.innerHTML = txt;
                }).catch(err => {
                    console.error(err);
                    el.style.width = originalWidth;
                    el.style.margin = originalMargin;
                    el.style.padding = originalPadding;
                    btn.innerHTML = txt;
                });
            }, 500);
        }
    </script>
</body>
</html>
